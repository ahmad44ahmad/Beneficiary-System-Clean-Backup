import{r,a9 as g,j as e,a0 as _,a4 as S,X as k,aD as C,F as A,T as L,aE as D}from"./index-BOMQ6ZnB.js";const T=()=>{const[N,x]=r.useState(!1),[m,h]=r.useState(!1),[p,j]=r.useState(null),[c,E]=r.useState(new Date().toISOString().slice(0,7)),[s,f]=r.useState(null);r.useEffect(()=>{y()},[c]);const y=async()=>{x(!0);const l=`${c}-01`,i=`${c}-31`,{data:t}=await g.from("daily_meals").select("meal_type, status").gte("meal_date",l).lte("meal_date",i).eq("status","consumed"),{data:o}=await g.from("contractor_evaluations").select("total_penalty_amount").gte("evaluation_date",l).lte("evaluation_date",i),n={breakfast:(t==null?void 0:t.filter(a=>a.meal_type==="فطور").length)||0,lunch:(t==null?void 0:t.filter(a=>a.meal_type==="غداء").length)||0,dinner:(t==null?void 0:t.filter(a=>a.meal_type==="عشاء").length)||0,snack:(t==null?void 0:t.filter(a=>a.meal_type.includes("خفيفة")).length)||0},d={breakfast:10,lunch:15,dinner:12,snack:5},u=n.breakfast*d.breakfast+n.lunch*d.lunch+n.dinner*d.dinner+n.snack*d.snack,b=(o==null?void 0:o.reduce((a,w)=>a+(w.total_penalty_amount||0),0))||0;f({mealCounts:n,grossTotal:u,totalPenalties:b,netTotal:u-b}),x(!1)},v=async()=>{if(s){h(!0);try{const{analyzeReport:l}=await D(async()=>{const{analyzeReport:t}=await import("./aiService-DTcmaeem.js");return{analyzeReport:t}},[]),i=await l(s);j(i)}catch(l){console.error(l),alert("تعذر إجراء التحليل الذكي. تأكد من إعداد مفتاح API.")}finally{h(!1)}}};return e.jsx("div",{className:"p-8 bg-gray-50 min-h-screen",dir:"rtl",children:e.jsxs("div",{className:"max-w-4xl mx-auto bg-white shadow-xl rounded-none p-12 print:shadow-none print:w-full",children:[e.jsxs("div",{className:"flex justify-between items-start border-b-2 border-gray-100 pb-8 mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-[#14415A] mb-2",children:"المستخلص الشهري للإعاشة"}),e.jsxs("p",{className:"text-gray-500",children:["الفترة: ",c]})]}),e.jsxs("div",{className:"text-left flex flex-col items-end gap-3",children:[e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"font-bold text-gray-800",children:"شركة الخليج للتموين"}),e.jsx("p",{className:"text-sm text-gray-500",children:"سجل تجاري: 1010101010"})]}),e.jsx("button",{onClick:v,disabled:m||!s,className:"print:hidden px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center gap-2 text-sm transition-all shadow-md hover:shadow-lg disabled:opacity-50",children:m?e.jsxs("span",{className:"flex items-center gap-2",children:["جاري التحليل ",e.jsx(_,{className:"w-4 h-4 animate-spin"})]}):e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(S,{className:"w-4 h-4"})," تحليل الذكاء الاصطناعي"]})})]})]}),p&&e.jsxs("div",{className:"mb-8 p-6 bg-purple-50 border border-purple-100 rounded-xl relative animate-in fade-in slide-in-from-top-4",children:[e.jsx("button",{onClick:()=>j(null),className:"absolute top-4 left-4 text-purple-400 hover:text-purple-700",children:e.jsx(k,{className:"w-5 h-5"})}),e.jsxs("h3",{className:"flex items-center gap-2 font-bold text-purple-800 mb-4",children:[e.jsx(C,{className:"w-6 h-6"}),"تحليل المساعد الذكي (Gemini)"]}),e.jsx("div",{className:"prose prose-sm max-w-none text-purple-900 leading-relaxed whitespace-pre-line",children:p})]}),N?e.jsx("div",{className:"py-12 text-center text-gray-400",children:"جاري الحساب..."}):s&&e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-bold text-lg mb-4 flex items-center gap-2",children:[e.jsx(A,{className:"w-5 h-5 text-blue-600"}),"ملخص الوجبات المقدمة"]}),e.jsxs("table",{className:"w-full border border-gray-200",children:[e.jsx("thead",{className:"bg-gray-50 text-gray-600 text-sm",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-3 text-right",children:"البيان"}),e.jsx("th",{className:"p-3 text-center",children:"العدد"}),e.jsx("th",{className:"p-3 text-center",children:"السعر الإفرادي"}),e.jsx("th",{className:"p-3 text-right",children:"الإجمالي"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-100",children:[e.jsxs("tr",{children:[e.jsx("td",{className:"p-3",children:"وجبات إفطار"}),e.jsx("td",{className:"p-3 text-center",children:s.mealCounts.breakfast}),e.jsx("td",{className:"p-3 text-center",children:"10 ر.س"}),e.jsxs("td",{className:"p-3 font-bold text-right",children:[(s.mealCounts.breakfast*10).toLocaleString()," ر.س"]})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"p-3",children:"وجبات غداء"}),e.jsx("td",{className:"p-3 text-center",children:s.mealCounts.lunch}),e.jsx("td",{className:"p-3 text-center",children:"15 ر.س"}),e.jsxs("td",{className:"p-3 font-bold text-right",children:[(s.mealCounts.lunch*15).toLocaleString()," ر.س"]})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"p-3",children:"وجبات عشاء"}),e.jsx("td",{className:"p-3 text-center",children:s.mealCounts.dinner}),e.jsx("td",{className:"p-3 text-center",children:"12 ر.س"}),e.jsxs("td",{className:"p-3 font-bold text-right",children:[(s.mealCounts.dinner*12).toLocaleString()," ر.س"]})]})]})]})]}),e.jsxs("div",{className:"bg-red-50 p-6 rounded-lg border border-red-100",children:[e.jsxs("h3",{className:"font-bold text-red-800 mb-2 flex items-center gap-2",children:[e.jsx(L,{className:"w-5 h-5"}),"الحسومات والغرامات (Quality Control)"]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("p",{className:"text-sm text-red-600",children:'تم احتساب الغرامات بناءً على تقارير الجودة اليومية وسجلات "لجنة الاستلام"'}),e.jsxs("span",{className:"text-xl font-bold text-red-700",children:["- ",s.totalPenalties.toLocaleString()," ر.س"]})]})]}),e.jsx("div",{className:"border-t-2 border-gray-800 pt-6 flex justify-end",children:e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-gray-500 mb-1",children:"صافي المبلغ المستحق"}),e.jsxs("p",{className:"text-4xl font-bold text-[#14415A]",children:[s.netTotal.toLocaleString()," ",e.jsx("span",{className:"text-lg",children:"ر.س"})]})]})}),e.jsxs("div",{className:"grid grid-cols-3 gap-8 mt-16 pt-8 border-t border-gray-200 text-center text-sm text-gray-500",children:[e.jsxs("div",{children:[e.jsx("p",{className:"mb-8",children:"أخضائي التغذية"}),e.jsx("div",{className:"border-b border-gray-300 w-3/4 mx-auto"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"mb-8",children:"المحاسب"}),e.jsx("div",{className:"border-b border-gray-300 w-3/4 mx-auto"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"mb-8",children:"مدير المركز"}),e.jsx("div",{className:"border-b border-gray-300 w-3/4 mx-auto"})]})]})]})]})})};export{T as MonthlyInvoice};
