import{r as i,a9 as u,j as e,L as C,a3 as R,T as m,P as L,J as $,aK as F,a1 as D,aL as E,q as I}from"./index-BOMQ6ZnB.js";const l={orange:"rgb(245, 150, 30)",gold:"rgb(250, 180, 20)",green:"rgb(45, 180, 115)",teal:"rgb(20, 130, 135)",navy:"rgb(20, 65, 90)"},T=[{id:"operational",name:"تشغيلية"},{id:"financial",name:"مالية"},{id:"compliance",name:"امتثال"},{id:"strategic",name:"استراتيجية"},{id:"reputational",name:"سمعة"},{id:"safety",name:"سلامة"}],M=()=>{const[n,j]=i.useState([]),[b,h]=i.useState(!0),[c,v]=i.useState(""),[d,y]=i.useState("all"),[N,x]=i.useState(!1),[t,r]=i.useState({risk_code:`RISK-${new Date().getFullYear()}-${String(Math.floor(Math.random()*999)).padStart(3,"0")}`,title_ar:"",description:"",category_id:"operational",likelihood:3,impact:3,risk_owner:"",response_strategy:"mitigate",mitigation_action:"",status:"identified"});i.useEffect(()=>{g()},[]);const g=async()=>{h(!0);const{data:s,error:a}=await u.from("grc_risks").select("*").order("risk_score",{ascending:!1});a||j(s||[]),h(!1)},f=async s=>{s.preventDefault();const{error:a}=await u.from("grc_risks").insert([t]);a||(x(!1),g(),r({...t,risk_code:`RISK-${new Date().getFullYear()}-${String(Math.floor(Math.random()*999)).padStart(3,"0")}`,title_ar:"",description:"",mitigation_action:""}))},w=s=>{const a={critical:{bg:"bg-red-600",text:"text-white",label:"حرج"},high:{bg:"bg-orange-500",text:"text-white",label:"عالي"},medium:{bg:"bg-yellow-400",text:"text-gray-800",label:"متوسط"},low:{bg:"bg-green-500",text:"text-white",label:"منخفض"}},{bg:o,text:_,label:S}=a[s]||a.low;return e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold ${o} ${_}`,children:S})},k=s=>{const a={identified:"تم التحديد",analyzing:"قيد التحليل",mitigating:"قيد المعالجة",monitoring:"تحت المراقبة",closed:"مغلق",escalated:"تم التصعيد"},o={identified:"bg-blue-100 text-blue-800",analyzing:"bg-purple-100 text-purple-800",mitigating:"bg-amber-100 text-amber-800",monitoring:"bg-cyan-100 text-cyan-800",closed:"bg-green-100 text-green-800",escalated:"bg-red-100 text-red-800"};return e.jsx("span",{className:`px-2 py-1 rounded text-xs ${o[s]||"bg-gray-100"}`,children:a[s]||s})},p=n.filter(s=>{const a=s.title_ar.includes(c)||s.risk_code.includes(c),o=d==="all"||s.risk_level===d;return a&&o});return e.jsxs("div",{className:"space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(C,{to:"/grc",className:"flex items-center gap-2 text-gray-500 hover:text-gray-700 mb-2",children:[e.jsx(R,{className:"w-4 h-4"}),"العودة للحوكمة"]}),e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-3",style:{color:l.navy},children:[e.jsx(m,{className:"w-7 h-7",style:{color:l.orange}}),"سجل المخاطر"]}),e.jsx("p",{className:"text-gray-500 mt-1",children:"تسجيل وتتبع ومعالجة المخاطر المؤسسية"})]}),e.jsxs("button",{onClick:()=>x(!0),className:"px-5 py-2.5 text-white rounded-xl flex items-center gap-2 shadow-lg hover:opacity-90 transition-opacity",style:{backgroundColor:l.orange},children:[e.jsx(L,{className:"w-5 h-5"}),"تسجيل خطر جديد"]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-4 flex flex-wrap gap-4 items-center",children:[e.jsxs("div",{className:"flex-1 min-w-[250px] relative",children:[e.jsx($,{className:"absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"البحث بالعنوان أو الرمز...",value:c,onChange:s=>v(s.target.value),className:"w-full pr-10 pl-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-[rgb(20,130,135)]"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(F,{className:"w-5 h-5 text-gray-400"}),e.jsxs("select",{value:d,onChange:s=>y(s.target.value),className:"px-4 py-2.5 border border-gray-200 rounded-xl",children:[e.jsx("option",{value:"all",children:"جميع المستويات"}),e.jsx("option",{value:"critical",children:"حرج"}),e.jsx("option",{value:"high",children:"عالي"}),e.jsx("option",{value:"medium",children:"متوسط"}),e.jsx("option",{value:"low",children:"منخفض"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-5 gap-4",children:[e.jsxs("div",{className:"bg-white rounded-xl p-4 shadow-lg text-center border-r-4",style:{borderRightColor:l.navy},children:[e.jsx("p",{className:"text-3xl font-bold",style:{color:l.navy},children:n.length}),e.jsx("p",{className:"text-sm text-gray-500",children:"إجمالي المخاطر"})]}),e.jsxs("div",{className:"bg-white rounded-xl p-4 shadow-lg text-center border-r-4 border-red-500",children:[e.jsx("p",{className:"text-3xl font-bold text-red-600",children:n.filter(s=>s.risk_level==="critical").length}),e.jsx("p",{className:"text-sm text-gray-500",children:"حرجة"})]}),e.jsxs("div",{className:"bg-white rounded-xl p-4 shadow-lg text-center border-r-4",style:{borderRightColor:l.orange},children:[e.jsx("p",{className:"text-3xl font-bold",style:{color:l.orange},children:n.filter(s=>s.risk_level==="high").length}),e.jsx("p",{className:"text-sm text-gray-500",children:"عالية"})]}),e.jsxs("div",{className:"bg-white rounded-xl p-4 shadow-lg text-center border-r-4",style:{borderRightColor:l.gold},children:[e.jsx("p",{className:"text-3xl font-bold",style:{color:l.gold},children:n.filter(s=>s.risk_level==="medium").length}),e.jsx("p",{className:"text-sm text-gray-500",children:"متوسطة"})]}),e.jsxs("div",{className:"bg-white rounded-xl p-4 shadow-lg text-center border-r-4",style:{borderRightColor:l.green},children:[e.jsx("p",{className:"text-3xl font-bold",style:{color:l.green},children:n.filter(s=>s.risk_level==="low").length}),e.jsx("p",{className:"text-sm text-gray-500",children:"منخفضة"})]})]}),e.jsx("div",{className:"bg-white rounded-xl shadow-lg overflow-hidden",children:b?e.jsx("div",{className:"py-12 text-center text-gray-400",children:"جاري التحميل..."}):p.length===0?e.jsxs("div",{className:"py-12 text-center text-gray-400",children:[e.jsx(m,{className:"w-16 h-16 mx-auto mb-4 opacity-30"}),e.jsx("p",{children:"لا توجد مخاطر مسجلة"})]}):e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"text-gray-600 text-sm",style:{backgroundColor:`${l.navy}10`},children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-4 text-right",children:"الرمز"}),e.jsx("th",{className:"p-4 text-right",children:"العنوان"}),e.jsx("th",{className:"p-4 text-center",children:"الاحتمال × التأثير"}),e.jsx("th",{className:"p-4 text-center",children:"المستوى"}),e.jsx("th",{className:"p-4 text-center",children:"الحالة"}),e.jsx("th",{className:"p-4 text-right",children:"المسؤول"}),e.jsx("th",{className:"p-4 text-center",children:"إجراءات"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:p.map(s=>e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsx("td",{className:"p-4 font-mono text-sm",children:s.risk_code}),e.jsxs("td",{className:"p-4",children:[e.jsx("div",{className:"font-medium",children:s.title_ar}),e.jsx("div",{className:"text-sm text-gray-500 truncate max-w-xs",children:s.description})]}),e.jsx("td",{className:"p-4 text-center",children:e.jsxs("span",{className:"font-mono bg-gray-100 px-3 py-1 rounded-lg",children:[s.likelihood," × ",s.impact," = ",e.jsx("strong",{children:s.risk_score})]})}),e.jsx("td",{className:"p-4 text-center",children:w(s.risk_level)}),e.jsx("td",{className:"p-4 text-center",children:k(s.status)}),e.jsx("td",{className:"p-4 text-sm",children:s.risk_owner||"-"}),e.jsx("td",{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("button",{className:"p-2 hover:bg-gray-100 rounded-lg",style:{color:l.teal},children:e.jsx(D,{className:"w-4 h-4"})}),e.jsx("button",{className:"p-2 hover:bg-gray-100 rounded-lg",style:{color:l.orange},children:e.jsx(E,{className:"w-4 h-4"})})]})})]},s.id))})]})}),N&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-2xl p-8 max-w-3xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-auto",children:[e.jsxs("h2",{className:"text-xl font-bold mb-6 flex items-center gap-2",style:{color:l.navy},children:[e.jsx(m,{className:"w-6 h-6",style:{color:l.orange}}),"تسجيل خطر جديد"]}),e.jsxs("form",{onSubmit:f,className:"space-y-5",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"رمز الخطر"}),e.jsx("input",{type:"text",value:t.risk_code,readOnly:!0,className:"w-full px-4 py-2.5 border rounded-xl bg-gray-50 font-mono"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"الفئة"}),e.jsx("select",{value:t.category_id,onChange:s=>r({...t,category_id:s.target.value}),className:"w-full px-4 py-2.5 border rounded-xl",children:T.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"عنوان الخطر *"}),e.jsx("input",{type:"text",value:t.title_ar,onChange:s=>r({...t,title_ar:s.target.value}),placeholder:"مثال: تعطل نظام الإطفاء الرئيسي",className:"w-full px-4 py-2.5 border rounded-xl focus:ring-2",style:{"--tw-ring-color":l.teal},required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"الوصف"}),e.jsx("textarea",{value:t.description,onChange:s=>r({...t,description:s.target.value}),className:"w-full px-4 py-2.5 border rounded-xl",rows:3})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"الاحتمالية (1-5)"}),e.jsxs("select",{value:t.likelihood,onChange:s=>r({...t,likelihood:parseInt(s.target.value)}),className:"w-full px-4 py-2.5 border rounded-xl",children:[e.jsx("option",{value:1,children:"1 - نادر جداً"}),e.jsx("option",{value:2,children:"2 - نادر"}),e.jsx("option",{value:3,children:"3 - ممكن"}),e.jsx("option",{value:4,children:"4 - محتمل"}),e.jsx("option",{value:5,children:"5 - مؤكد تقريباً"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"التأثير (1-5)"}),e.jsxs("select",{value:t.impact,onChange:s=>r({...t,impact:parseInt(s.target.value)}),className:"w-full px-4 py-2.5 border rounded-xl",children:[e.jsx("option",{value:1,children:"1 - ضئيل"}),e.jsx("option",{value:2,children:"2 - طفيف"}),e.jsx("option",{value:3,children:"3 - متوسط"}),e.jsx("option",{value:4,children:"4 - كبير"}),e.jsx("option",{value:5,children:"5 - كارثي"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"درجة الخطر"}),e.jsx("div",{className:"w-full px-4 py-2.5 border rounded-xl text-center font-bold text-xl",style:{backgroundColor:t.likelihood*t.impact>=20?"#dc2626":t.likelihood*t.impact>=12?l.orange:t.likelihood*t.impact>=6?l.gold:l.green,color:"white"},children:t.likelihood*t.impact})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"استراتيجية الاستجابة"}),e.jsxs("select",{value:t.response_strategy,onChange:s=>r({...t,response_strategy:s.target.value}),className:"w-full px-4 py-2.5 border rounded-xl",children:[e.jsx("option",{value:"avoid",children:"تجنب"}),e.jsx("option",{value:"mitigate",children:"تخفيف"}),e.jsx("option",{value:"transfer",children:"نقل"}),e.jsx("option",{value:"accept",children:"قبول"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"مسؤول الخطر"}),e.jsx("input",{type:"text",value:t.risk_owner,onChange:s=>r({...t,risk_owner:s.target.value}),className:"w-full px-4 py-2.5 border rounded-xl"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"إجراء التخفيف"}),e.jsx("textarea",{value:t.mitigation_action,onChange:s=>r({...t,mitigation_action:s.target.value}),className:"w-full px-4 py-2.5 border rounded-xl",rows:2})]}),e.jsxs("div",{className:"flex gap-3 justify-end pt-4 border-t",children:[e.jsx("button",{type:"button",onClick:()=>x(!1),className:"px-6 py-2.5 bg-gray-100 rounded-xl hover:bg-gray-200",children:"إلغاء"}),e.jsxs("button",{type:"submit",className:"px-6 py-2.5 text-white rounded-xl flex items-center gap-2",style:{backgroundColor:l.teal},children:[e.jsx(I,{className:"w-4 h-4"}),"حفظ الخطر"]})]})]})]})})]})};export{M as RiskRegister,M as default};
