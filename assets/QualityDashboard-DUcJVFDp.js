import{r as c,a9 as m,j as e,a0 as g,ac as b,n as N,v as f}from"./index-BOMQ6ZnB.js";import{a4 as w,a5 as y}from"./CategoricalChart-CVOu2Sdu.js";import{B as v,a as _}from"./BarChart-CapdVOWV.js";import{X as A,Y as D}from"./CartesianChart-BCPM_Iof.js";import{C as E}from"./tooltipContext-aDNLGl9E.js";import"./ErrorBarContext-DeCBPfcE.js";import"./graphicalItemSelectors-D0O9Wiuq.js";const K=()=>{const[x,h]=c.useState(!0),[r,p]=c.useState({totalDeductions:0,compliantPercentage:0,topViolations:[],recentEvals:[]});c.useEffect(()=>{j()},[]);const j=async()=>{try{const s=new Date;s.setDate(1);const{data:t}=await m.from("contractor_evaluations").select("total_penalty_amount, evaluation_date, id, supplier:catering_suppliers(name)").gte("evaluation_date",s.toISOString()),u=(t==null?void 0:t.reduce((l,a)=>l+(a.total_penalty_amount||0),0))||0,{data:n}=await m.from("evaluation_answers").select("criteria:evaluation_criteria(category)").eq("status","non_compliant"),i={};n==null||n.forEach(l=>{var d;const a=((d=l.criteria)==null?void 0:d.category)||"General";i[a]=(i[a]||0)+1});const o=Object.entries(i).map(([l,a])=>({name:l,count:a})).sort((l,a)=>a.count-l.count).slice(0,5);p({totalDeductions:u,compliantPercentage:85,topViolations:o.length>0?o:[{name:"النظافة",count:5},{name:"الطعام",count:3}],recentEvals:(t==null?void 0:t.slice(0,5))||[]})}catch(s){console.error("Error fetching dashboard:",s)}finally{h(!1)}};return x?e.jsx("div",{className:"flex justify-center p-12",children:e.jsx(g,{className:"animate-spin"})}):e.jsxs("div",{className:"bg-gray-50 min-h-screen p-6",dir:"rtl",children:[e.jsx("h1",{className:"text-2xl font-bold text-[#14415A] mb-6",children:"لوحة قيادة الجودة"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6 mb-8",children:[e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-sm border-r-4 border-red-500",children:[e.jsx("p",{className:"text-gray-500 text-sm font-medium mb-1",children:"إجمالي الحسومات (شهري)"}),e.jsxs("h3",{className:"text-3xl font-bold text-[#14415A]",children:[r.totalDeductions," ريال"]}),e.jsxs("div",{className:"flex items-center gap-1 text-red-500 text-xs mt-2",children:[e.jsx(b,{className:"w-4 h-4"}),e.jsx("span",{children:"+12% عن الشهر الماضي"})]})]}),e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-sm border-r-4 border-green-500",children:[e.jsx("p",{className:"text-gray-500 text-sm font-medium mb-1",children:"نسبة الامتثال"}),e.jsxs("h3",{className:"text-3xl font-bold text-[#14415A]",children:[r.compliantPercentage,"%"]}),e.jsxs("div",{className:"flex items-center gap-1 text-green-500 text-xs mt-2",children:[e.jsx(N,{className:"w-4 h-4"}),e.jsx("span",{children:"أداء جيد جداً"})]})]}),e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-sm border-r-4 border-yellow-500",children:[e.jsx("p",{className:"text-gray-500 text-sm font-medium mb-1",children:"عدد المخالفات"}),e.jsx("h3",{className:"text-3xl font-bold text-[#14415A]",children:r.topViolations.reduce((s,t)=>s+t.count,0)})]}),e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-sm border-r-4 border-blue-500",children:[e.jsx("p",{className:"text-gray-500 text-sm font-medium mb-1",children:"التقييم العام للمتعهد"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"text-3xl font-bold text-[#14415A]",children:"4.5/5"}),e.jsx(f,{className:"w-8 h-8 text-yellow-500"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-sm",children:[e.jsx("h3",{className:"font-bold text-[#14415A] mb-6",children:"أكثر المخالفات شيوعاً"}),e.jsx("div",{className:"h-64",children:e.jsx(w,{width:"100%",height:"100%",children:e.jsxs(v,{data:r.topViolations,children:[e.jsx(A,{dataKey:"name"}),e.jsx(D,{}),e.jsx(y,{}),e.jsx(_,{dataKey:"count",fill:"#14415A",radius:[5,5,0,0],children:r.topViolations.map((s,t)=>e.jsx(E,{fill:t%2===0?"#14415A":"#F5961E"},`cell-${t}`))})]})})})]}),e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-sm",children:[e.jsx("h3",{className:"font-bold text-[#14415A] mb-6",children:"آخر التقييمات"}),e.jsxs("table",{className:"w-full text-right text-sm",children:[e.jsx("thead",{className:"bg-gray-50 text-gray-600",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-3",children:"التاريخ"}),e.jsx("th",{className:"p-3",children:"المتعهد"}),e.jsx("th",{className:"p-3",children:"الحسم"})]})}),e.jsxs("tbody",{className:"divide-y",children:[r.recentEvals.map(s=>{var t;return e.jsxs("tr",{children:[e.jsx("td",{className:"p-3",children:new Date(s.evaluation_date).toLocaleDateString("ar-SA")}),e.jsx("td",{className:"p-3 font-medium",children:(t=s.supplier)==null?void 0:t.name}),e.jsxs("td",{className:"p-3 text-red-600 font-bold",children:[s.total_penalty_amount," ريال"]})]},s.id)}),r.recentEvals.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"p-4 text-center text-gray-400",children:"لا توجد بيانات حديثة"})})]})]})]})]})]})};export{K as QualityDashboard};
