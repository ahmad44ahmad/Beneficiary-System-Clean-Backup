import{j as e,O as D,X as C,a7 as v,i as w,c as E,r as o,a9 as m,Y as O,a0 as _,ax as R,ay as L,k as $,q,G as A,az as F,ab as I}from"./index-BOMQ6ZnB.js";const M={pending:{label:"معلق",bgColor:"bg-gray-100",textColor:"text-gray-500",icon:E},preparing:{label:"قيد التحضير",bgColor:"bg-yellow-50",textColor:"text-yellow-600",icon:E},ready:{label:"جاهز",bgColor:"bg-blue-50",textColor:"text-blue-600",icon:w},delivered:{label:"تم التسليم",bgColor:"bg-blue-50",textColor:"text-blue-600",icon:w},consumed:{label:"تم الاستهلاك",bgColor:"bg-green-50",textColor:"text-green-600",icon:v},refused:{label:"رفض الوجبة",bgColor:"bg-red-50",textColor:"text-red-600",icon:C},active:{label:"نشط",bgColor:"bg-green-50",textColor:"text-green-600",icon:v},inactive:{label:"غير نشط",bgColor:"bg-gray-100",textColor:"text-gray-500"},completed:{label:"مكتمل",bgColor:"bg-green-50",textColor:"text-green-600",icon:v},cancelled:{label:"ملغى",bgColor:"bg-red-50",textColor:"text-red-600",icon:C},low:{label:"منخفض",bgColor:"bg-green-50",textColor:"text-green-600"},medium:{label:"متوسط",bgColor:"bg-yellow-50",textColor:"text-yellow-600"},high:{label:"عالي",bgColor:"bg-orange-50",textColor:"text-orange-600",icon:D},critical:{label:"حرج",bgColor:"bg-red-50",textColor:"text-red-600",icon:D}},T=({status:u,size:s="md",showIcon:c=!0})=>{const d=M[u]||{label:u,bgColor:"bg-gray-100",textColor:"text-gray-500",icon:void 0},b=s==="sm"?"px-2 py-0.5 text-xs":"px-3 py-1 text-sm",i=s==="sm"?"w-3 h-3":"w-4 h-4";return e.jsxs("span",{className:`inline-flex items-center gap-1 ${d.bgColor} ${d.textColor} ${b} rounded-full font-medium`,children:[c&&d.icon&&e.jsx(d.icon,{className:i}),d.label]})},N=[{id:"nutritionist",title:"أخصائي التغذية",label:"Nutritionist"},{id:"supervisor",title:"مشرف الفترة",label:"Shift Supervisor"},{id:"director",title:"مدير المركز",label:"Center Director"}],z=({date:u})=>{const[s,c]=o.useState(null),[d,b]=o.useState(!0),[i,y]=o.useState("nutritionist"),[x,f]=o.useState(!1),p=u.toISOString().split("T")[0];o.useEffect(()=>{j()},[p]);const j=async()=>{b(!0);const{data:l,error:t}=await m.from("catering_daily_reports").select("*").eq("report_date",p).single();t&&t.code!=="PGRST116"&&console.error("Error fetching report:",t),c(l||null),b(!1)},h=async()=>{var l;f(!0);try{const t={name:i==="nutritionist"?"د. أحمد (تشبيه)":i==="supervisor"?"مشرف 1":"المدير العام",role_title:((l=N.find(r=>r.id===i))==null?void 0:l.title)||"",signed_at:new Date().toISOString(),user_id:"demo-user-id"};let a={...s==null?void 0:s.signatures};a[i]=t;const n=N.every(r=>a[r.id])?"approved":"pending_approval";if(s){const{error:r}=await m.from("catering_daily_reports").update({signatures:a,status:n}).eq("id",s.id);if(r)throw r}else{const{error:r}=await m.from("catering_daily_reports").insert({report_date:p,signatures:a,status:n});if(r)throw r}await j()}catch(t){console.error("Failed to sign:",t),alert("حدث خطأ أثناء التوقيع")}finally{f(!1)}};return e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 p-6 mt-8",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 bg-blue-50 rounded-lg text-blue-700",children:e.jsx(O,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold text-[#14415A]",children:"لجنة الاستلام الرقمية"}),e.jsx("p",{className:"text-gray-500 text-sm",children:"التوقيع والمصادقة الإلكترونية على الاستلام"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 bg-gray-50 p-1 rounded-lg border border-gray-200",children:[e.jsx("span",{className:"text-xs text-gray-500 px-2",children:"تجربة بصمة:"}),N.map(l=>e.jsx("button",{onClick:()=>y(l.id),className:`px-3 py-1 text-xs rounded-md transition-colors ${i===l.id?"bg-white shadow-sm text-blue-700 font-bold border border-blue-100":"text-gray-500 hover:text-gray-700"}`,children:l.title},l.id))]})]}),d?e.jsx("div",{className:"py-8 flex justify-center",children:e.jsx(_,{className:"w-8 h-8 animate-spin text-gray-300"})}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:N.map(l=>{var g;const t=(g=s==null?void 0:s.signatures)==null?void 0:g[l.id],a=i===l.id;return e.jsxs("div",{className:`relative p-5 rounded-xl border-2 transition-all ${t?"border-green-100 bg-green-50/50":a?"border-blue-200 bg-blue-50/30 shadow-md ring-2 ring-blue-100/50":"border-dashed border-gray-200 bg-gray-50/50 opacity-70"}`,children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsx("span",{className:`text-sm font-bold ${t?"text-green-700":"text-gray-600"}`,children:l.title}),t?e.jsx(v,{className:"w-5 h-5 text-green-600"}):e.jsx(R,{className:"w-5 h-5 text-gray-400"})]}),t?e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"font-bold text-gray-900",children:t.name}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",dir:"ltr",children:new Date(t.signed_at).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"})}),e.jsxs("div",{className:"mt-3 flex items-center gap-1 text-[10px] text-green-700 font-medium bg-green-100 w-fit px-2 py-0.5 rounded-full",children:[e.jsx(L,{className:"w-3 h-3"}),"تم التوقيع رقمياً"]})]}):e.jsx("div",{className:"text-center py-2",children:a?e.jsx("button",{onClick:h,disabled:x,className:"w-full py-2 bg-[#14415A] text-white rounded-lg text-sm font-medium hover:bg-[#0f3246] transition-all active:scale-95 disabled:opacity-50 flex justify-center items-center gap-2",children:x?e.jsx(_,{className:"w-4 h-4 animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(L,{className:"w-4 h-4"}),"اعتماد (توقيع)"]})}):e.jsx("p",{className:"text-xs text-gray-400 italic",children:"بانتظار التوقيع..."})})]},l.id)})}),e.jsxs("div",{className:"mt-6 pt-4 border-t border-gray-100 flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"حالة التقرير اليومي:"}),e.jsx("span",{className:`px-2 py-1 rounded-md font-bold ${(s==null?void 0:s.status)==="approved"?"bg-green-100 text-green-700":(s==null?void 0:s.status)==="pending_approval"?"bg-yellow-100 text-yellow-700":"bg-gray-100 text-gray-600"}`,children:(s==null?void 0:s.status)==="approved"?"مكتمل ومعتمد":(s==null?void 0:s.status)==="pending_approval"?"بانتظار الاكتمال":"مسودة"})]}),(s==null?void 0:s.status)==="approved"&&e.jsxs("div",{className:"text-xs text-gray-400",children:["الرقم المرجعي: ",s.id.slice(0,8)]})]})]})},P=()=>{const u=$(),[s,c]=o.useState(!1),[d,b]=o.useState(!1),[i,y]=o.useState([]),[x,f]=o.useState("غداء");o.useEffect(()=>{p()},[x]);const p=async()=>{c(!0);try{const t=new Date().toISOString().split("T")[0],{data:a,error:g}=await m.from("daily_meals").select(`
                    id, 
                    status, 
                    meal_type,
                    beneficiaries!inner ( full_name ),
                    dietary_plans ( plan_type )
                `).eq("meal_date",t).eq("meal_type",x);if(a){const n=a.map(r=>{var S,k;return{id:r.id,beneficiary_name:(S=r.beneficiaries)==null?void 0:S.full_name,plan_type:((k=r.dietary_plans)==null?void 0:k.plan_type)||"قياسي",status:r.status,meal_type:r.meal_type}});y(n)}}catch(t){console.error(t)}finally{c(!1)}},j=async()=>{b(!0);try{const{data:t}=await m.from("beneficiaries").select("id").eq("status","active");if(!(t!=null&&t.length))return;const a=new Date().toISOString().split("T")[0],g=t.map(r=>({beneficiary_id:r.id,meal_date:a,meal_type:x,status:"pending"})),{error:n}=await m.from("daily_meals").upsert(g,{onConflict:"beneficiary_id,meal_date,meal_type"});n?console.error(n):p()}finally{b(!1)}},h=async(t,a)=>{y(g=>g.map(n=>n.id===t?{...n,status:a}:n)),await m.from("daily_meals").update({status:a,updated_at:new Date().toISOString()}).eq("id",t)},l=async()=>{const t=i.filter(a=>a.status==="pending").map(a=>a.id);t.length&&(c(!0),await m.from("daily_meals").update({status:"delivered",updated_at:new Date().toISOString()}).in("id",t),p())};return e.jsxs("div",{className:"p-6 bg-gray-50 min-h-screen",dir:"rtl",children:[e.jsxs("header",{className:"flex justify-between items-center mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-[#14415A]",children:"تسجيل الوجبات اليومي"}),e.jsxs("p",{className:"text-gray-600",children:["إدارة توزيع وجبات: ",x]})]}),e.jsx("div",{className:"flex gap-3",children:e.jsx("button",{onClick:()=>u("/catering"),className:"px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50",children:"عودة للوحة القيادة"})})]}),e.jsxs("div",{className:"bg-white p-4 rounded-xl shadow-sm mb-6 flex flex-wrap gap-4 items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-medium text-gray-700",children:"نوع الوجبة:"}),e.jsxs("select",{value:x,onChange:t=>f(t.target.value),className:"border-gray-300 rounded-lg focus:ring-[#F5961E] focus:border-[#F5961E]",children:[e.jsx("option",{value:"فطور",children:"فطور"}),e.jsx("option",{value:"غداء",children:"غداء"}),e.jsx("option",{value:"عشاء",children:"عشاء"}),e.jsx("option",{value:"وجبة خفيفة 1",children:"وجبة خفيفة 1"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[i.length===0?e.jsxs("button",{onClick:j,disabled:d,className:"px-4 py-2 bg-[#148287] text-white rounded-lg hover:bg-[#0e6b6f] flex items-center gap-2",children:[d?e.jsx(_,{className:"animate-spin w-4 h-4"}):e.jsx(q,{className:"w-4 h-4"}),"إنشاء قائمة الوجبات"]}):e.jsxs("button",{onClick:l,className:"px-4 py-2 bg-[#F5961E] text-white rounded-lg hover:bg-[#d98210] flex items-center gap-2",children:[e.jsx(w,{className:"w-4 h-4"}),'تسجيل الكل "تم التسليم"']}),e.jsxs("button",{className:"px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 flex items-center gap-2",children:[e.jsx(A,{className:"w-4 h-4"}),"طباعة"]})]})]}),e.jsx("div",{className:"bg-white rounded-xl shadow-sm overflow-hidden",children:s?e.jsx("div",{className:"p-12 flex justify-center",children:e.jsx(F,{size:"md"})}):i.length===0?e.jsx("div",{className:"p-12 text-center text-gray-500",children:"لا توجد وجبات مسجلة في النظام لهذا الوقت. قم بإنشاء القائمة أولاً."}):e.jsxs("table",{className:"w-full text-right",children:[e.jsx("thead",{className:"bg-[#14415A] text-white text-sm",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-4",children:"المستفيد"}),e.jsx("th",{className:"px-6 py-4",children:"النظام الغذائي"}),e.jsx("th",{className:"px-6 py-4",children:"الحالة"}),e.jsx("th",{className:"px-6 py-4 text-center",children:"الإجراءات"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:i.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsx("td",{className:"px-6 py-4 font-medium",children:t.beneficiary_name}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("span",{className:`px-2 py-1 rounded text-xs ${t.plan_type==="قياسي"?"bg-gray-100 text-gray-600":"bg-red-100 text-red-700 font-bold"}`,children:t.plan_type})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(T,{status:t.status})}),e.jsx("td",{className:"px-6 py-4 flex justify-center gap-2",children:t.status!=="consumed"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>h(t.id,"delivered"),title:"تم التسليم",className:"p-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100",children:e.jsx(I,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>h(t.id,"consumed"),title:"تم الاستهلاك",className:"p-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100",children:e.jsx(w,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>h(t.id,"refused"),title:"رفض",className:"p-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100",children:e.jsx(C,{className:"w-4 h-4"})})]})})]},t.id))})]})}),e.jsx(z,{date:new Date})]})};export{P as CateringDailyLog};
