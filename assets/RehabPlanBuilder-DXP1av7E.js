import{f as P,ar as A,u as R,r as h,j as e,a5 as w,A as T,P as S,w as C,B as j,C as z,F as G,n as M,q as O}from"./index-BOMQ6ZnB.js";import{I as k}from"./Input-C08-tSFm.js";const $=t=>h.useMemo(()=>{var i,x,n,u,r;const c=[];return t&&(((i=t.medicalDiagnosis)!=null&&i.includes("Cerebral Palsy")||(x=t.medicalDiagnosis)!=null&&x.includes("شلل"))&&c.push({type:"physiotherapy",title:"تحسين المدى الحركي (ROM)",reason:"بناءً على التشخيص الطبي: شلل/إعاقة حركية"}),((n=t.medicalDiagnosis)!=null&&n.includes("Speech")||(u=t.medicalDiagnosis)!=null&&u.includes("نطق"))&&c.push({type:"medical",title:"جلسات تخاطب مكثفة",reason:"بناءً على التشخيص الطبي: صعوبات نطق"}),(t.socialStatus==="Low Income"||(r=t.notes)!=null&&r.includes("دخل محدود"))&&c.push({type:"social",title:"دراسة طلب أجهزة تعويضية",reason:"دمج البيانات: دخل محدود + احتياج محتمل"}),t.age<18&&c.push({type:"social",title:"دمج في برامج التعليم الخاص",reason:"السن يسمح بالدمج التعليمي"})),c},[t]),L=()=>{var N,y,b;const{currentUser:t,hasPermission:c}=P(),{showToast:i}=A(),{beneficiaries:x}=R(),[n,u]=h.useState(""),r=h.useMemo(()=>x.find(s=>s.id===n)||null,[x,n]),[m,p]=h.useState({status:"draft",goals:[],approvals:[{role:"doctor",status:"pending"},{role:"social_worker",status:"pending"},{role:"director",status:"pending"}]}),f=$(r);h.useEffect(()=>{r&&p(s=>({...s,beneficiaryId:r.id,beneficiaryName:r.fullName,medicalContext:{diagnosis:r.medicalDiagnosis,needs:[]},socialContext:{economicStatus:r.socialStatus,riskLevel:"medium"},goals:[]}))},[r]);const v=s=>{if(!n){i("يرجى اختيار مستفيد أولاً","error");return}const l={id:`goal-${Date.now()}`,type:(s==null?void 0:s.type)||"medical",title:(s==null?void 0:s.title)||"",measureOfSuccess:"",targetDate:"",progress:0,status:"pending",assignedTo:(t==null?void 0:t.name)||"Unassigned"};p(a=>({...a,goals:[...a.goals||[],l]})),s&&i("تم إضافة المقترح بنجاح","success")},g=(s,l)=>{p(a=>{var d;return{...a,goals:(d=a.goals)==null?void 0:d.map(o=>o.id===s?{...o,...l}:o)}})},D=s=>{p(l=>{var a;return{...l,goals:(a=l.goals)==null?void 0:a.filter(d=>d.id!==s)}}),i("تم حذف الهدف","info")},I=s=>{if(!c(s)&&t.role!=="admin"){i(`عذراً، فقط ${s} يمكنه اعتماد هذه الخطوة`,"error");return}p(a=>{var d;return{...a,approvals:(d=a.approvals)==null?void 0:d.map(o=>o.role===s?{...o,status:"approved",approvedBy:t==null?void 0:t.name,approvedAt:new Date().toISOString()}:o)}}),i("تم الاعتماد بنجاح","success")},B=()=>{if(!m.beneficiaryId){i("لا يمكن حفظ خطة فارغة","error");return}i("تم حفظ مسودة الخطة بنجاح","success")};return e.jsxs("div",{className:"h-[calc(100vh-100px)] flex flex-col animate-in fade-in",children:[e.jsxs("div",{className:"bg-white border-b p-4 flex justify-between items-center shadow-sm z-10",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-xl font-bold text-gray-900 flex items-center gap-2",children:[e.jsx(w,{className:"w-6 h-6 text-purple-600"}),"الخطة التأهيلية الذكية (Smart IRP)"]}),e.jsx("p",{className:"text-xs text-gray-500",children:"نظام دعم القرار القائم على دمج البيانات"})]}),e.jsx("div",{className:"w-72",children:e.jsxs("select",{className:"w-full border rounded-md p-2 bg-gray-50 text-sm",value:n,onChange:s=>u(s.target.value),children:[e.jsx("option",{value:"",children:"اختر مستفيد لبدء الخطة..."}),x.map(s=>e.jsx("option",{value:s.id,children:s.fullName},s.id))]})})]}),e.jsxs("div",{className:"flex-1 grid grid-cols-12 gap-0 bg-gray-50 overflow-hidden",children:[e.jsxs("div",{className:"col-span-3 border-l bg-white p-4 overflow-y-auto",children:[e.jsxs("h3",{className:"font-bold text-gray-700 mb-4 flex items-center gap-2",children:[e.jsx(T,{className:"w-4 h-4"}),"السياق والمقترحات"]}),r?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"bg-primary-50 p-3 rounded-lg border border-primary-100",children:[e.jsx("span",{className:"text-primary-500 block text-xs mb-1",children:"التشخيص الطبي"}),e.jsx("span",{className:"font-medium text-gray-900",children:r.medicalDiagnosis})]}),e.jsxs("div",{className:"bg-green-50 p-3 rounded-lg border border-green-100",children:[e.jsx("span",{className:"text-green-600 block text-xs mb-1",children:"الوضع الاجتماعي"}),e.jsx("div",{className:"flex justify-between",children:e.jsx("span",{className:"font-medium text-gray-900",children:r.socialStatus})})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-bold text-purple-700 uppercase tracking-wider mb-2",children:"مقترحات الذكاء الاصطناعي"}),e.jsxs("div",{className:"space-y-2",children:[f.map((s,l)=>e.jsxs("div",{className:"group relative bg-purple-50 hover:bg-purple-100 border border-purple-200 p-3 rounded-lg transition-all cursor-pointer",onClick:()=>v(s),children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("span",{className:"font-medium text-purple-900 text-sm",children:s.title}),e.jsx(S,{className:"w-4 h-4 text-purple-500 opacity-0 group-hover:opacity-100 transition-opacity"})]}),e.jsxs("div",{className:"mt-1 text-xs text-purple-600 flex items-center gap-1",children:[e.jsx(w,{className:"w-3 h-3"}),s.reason]})]},l)),f.length===0&&e.jsx("p",{className:"text-sm text-gray-400 italic",children:"لا توجد مقترحات لهذا الملف."})]})]})]}):e.jsx("div",{className:"text-center text-gray-400 mt-10",children:"اختر مستفيداً لعرض التحليل"})]}),e.jsxs("div",{className:"col-span-6 p-6 overflow-y-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("h2",{className:"text-lg font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(C,{className:"w-5 h-5"}),"أهداف الخطة (SMART Goals)"]}),e.jsxs(j,{onClick:()=>v(),size:"sm",variant:"outline",children:[e.jsx(S,{className:"w-4 h-4 ml-2"}),"إضافة هدف يدوي"]})]}),e.jsxs("div",{className:"space-y-4",children:[(N=m.goals)==null?void 0:N.map((s,l)=>e.jsxs(z,{className:"p-4 border-r-4 border-r-primary-500 shadow-sm hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(k,{className:"font-bold text-gray-900 mb-2",value:s.title,onChange:a=>g(s.id,{title:a.target.value}),placeholder:"عنوان الهدف..."}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("select",{className:"text-xs border rounded p-1 bg-gray-50",value:s.type,onChange:a=>g(s.id,{type:a.target.value}),children:[e.jsx("option",{value:"medical",children:"طبي"}),e.jsx("option",{value:"physiotherapy",children:"علاج طبيعي"}),e.jsx("option",{value:"social",children:"اجتماعي"}),e.jsx("option",{value:"psychological",children:"نفسي"})]}),e.jsx(k,{className:"text-xs flex-1",value:s.measureOfSuccess,onChange:a=>g(s.id,{measureOfSuccess:a.target.value}),placeholder:"معيار النجاح (Measurable)..."})]})]}),e.jsx(j,{variant:"ghost",size:"sm",className:"text-red-500 hover:text-red-700",onClick:()=>D(s.id),children:"حذف"})]}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg mt-2",children:[e.jsxs("div",{className:"flex justify-between text-xs mb-2",children:[e.jsx("span",{className:"font-semibold text-gray-600",children:"مؤشر التقدم (KPI Tracker)"}),e.jsxs("span",{className:`font-bold ${s.progress===100?"text-green-600":"text-primary-600"}`,children:[s.progress,"%"]})]}),e.jsx("input",{type:"range",min:"0",max:"100",value:s.progress,onChange:a=>g(s.id,{progress:parseInt(a.target.value)}),className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary"})]})]},s.id)),((y=m.goals)==null?void 0:y.length)===0&&e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-xl p-10 text-center",children:[e.jsx(C,{className:"w-10 h-10 text-gray-300 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 font-medium",children:"الخطة فارغة"}),e.jsx("p",{className:"text-sm text-gray-400 mt-1",children:"اسحب المقترحات من اليمين أو أضف هدفاً يدوياً"})]})]})]}),e.jsxs("div",{className:"col-span-3 border-r bg-white p-4 overflow-y-auto",children:[e.jsxs("h3",{className:"font-bold text-gray-700 mb-4 flex items-center gap-2",children:[e.jsx(G,{className:"w-4 h-4"}),"الاعتماد والحوكمة"]}),e.jsx("div",{className:"space-y-4",children:(b=m.approvals)==null?void 0:b.map(s=>{var l;return e.jsxs("div",{className:`p-4 rounded-lg border transition-colors ${s.status==="approved"?"bg-green-50 border-green-200":"bg-gray-50 border-gray-200"}`,children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("span",{className:"font-bold text-sm text-gray-700 capitalize",children:s.role.replace("_"," ")}),s.status==="approved"&&e.jsx(M,{className:"w-4 h-4 text-green-600"})]}),s.status==="approved"?e.jsxs("div",{className:"text-xs text-green-700",children:[e.jsxs("div",{children:["Approved by: ",s.approvedBy]}),e.jsx("div",{className:"text-green-600 opacity-75",children:new Date(s.approvedAt).toLocaleDateString()})]}):e.jsx(j,{className:"w-full text-xs",size:"sm",variant:s.role==="director"?"default":"outline",onClick:()=>I(s.role),disabled:s.role==="director"&&((l=m.approvals)==null?void 0:l.some(a=>a.role!=="director"&&a.status!=="approved")),children:s.role==="director"?"الاعتماد النهائي":"موافقة"})]},s.role)})}),e.jsxs("div",{className:"mt-8 pt-6 border-t",children:[e.jsxs(j,{className:"w-full bg-primary hover:bg-primary-600 text-white mb-3",onClick:B,children:[e.jsx(O,{className:"w-4 h-4 ml-2"}),"حفظ المسودة"]}),e.jsx("p",{className:"text-xs text-center text-gray-400",children:"لا يمكن الاعتماد النهائي إلا بعد اكتمال موافقات الفريق الطبي والاجتماعي."})]})]})]})]})};export{L as RehabPlanBuilder};
