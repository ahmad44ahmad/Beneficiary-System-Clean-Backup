import{r as l,a9 as d,j as e,a0 as q,a8 as P,n as T,V as F,aC as M,q as U}from"./index-BOMQ6ZnB.js";const B=()=>{const[D,b]=l.useState(!0),[f,j]=l.useState(!1),[O,c]=l.useState([]),[N,x]=l.useState([]),[v,o]=l.useState(""),[n,y]=l.useState({}),[u,g]=l.useState({}),[h,w]=l.useState({}),[_,S]=l.useState(""),i=[{id:"demo-1",name:"شركة الأغذية المتحدة"},{id:"demo-2",name:"مطاعم الرياض للتموين"}],p=[{id:"1",category:"النظافة",question:"زي العمال نظيف ومرتب",max_score:10},{id:"2",category:"النظافة",question:"نظافة أدوات التقديم",max_score:10},{id:"3",category:"الطعام",question:"درجة حرارة الطعام مناسبة",max_score:10},{id:"4",category:"الطعام",question:"جودة المواد الخام",max_score:10},{id:"5",category:"الخدمة",question:"الالتزام بمواعيد التوصيل",max_score:10},{id:"6",category:"الخدمة",question:"تعامل الموظفين مع المستفيدين",max_score:10}];l.useEffect(()=>{I()},[]);const I=async()=>{b(!0);try{if(!d){c(i),x(p),o(i[0].id);return}const{data:s,error:a}=await d.from("catering_suppliers").select("*");a||!(s!=null&&s.length)?(c(i),o(i[0].id)):(c(s),s.length>0&&o(s[0].id));const{data:t,error:r}=await d.from("evaluation_criteria").select("*").eq("is_active",!0).order("category");r||!(t!=null&&t.length)?x(p):x(t)}catch{c(i),x(p),o(i[0].id)}finally{b(!1)}},C=(s,a)=>{y(t=>({...t,[s]:a})),a==="compliant"&&g(t=>{const r={...t};return delete r[s],r})},R=(s,a)=>{g(t=>({...t,[s]:parseFloat(a)||0}))},E=()=>Object.values(u).reduce((s,a)=>s+(a||0),0),A=async()=>{j(!0);try{const s=E(),{data:a,error:t}=await d.from("contractor_evaluations").insert({supplier_id:v,evaluation_date:new Date().toISOString(),total_penalty_amount:s,notes:_}).select().single();if(t)throw t;const r=N.map(m=>({evaluation_id:a.id,criteria_id:m.id,status:n[m.id]||"n/a",deduction_amount:u[m.id]||0,observation_text:h[m.id]||""})),{error:k}=await d.from("evaluation_answers").insert(r);if(k)throw k;alert("تم حفظ التقييم بنجاح"),y({}),g({}),w({}),S("")}catch(s){console.error("Error saving evaluation:",s),alert("حدث خطأ أثناء الحفظ")}finally{j(!1)}};if(D)return e.jsx("div",{className:"flex justify-center p-12",children:e.jsx(q,{className:"animate-spin"})});const L=N.reduce((s,a)=>(s[a.category]||(s[a.category]=[]),s[a.category].push(a),s),{});return e.jsxs("div",{className:"bg-gray-50 min-h-screen p-6",dir:"rtl",children:[e.jsxs("header",{className:"mb-8 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-[#14415A]",children:"مراقبة الجودة وتقييم المتعهد"}),e.jsx("p",{className:"text-gray-600",children:"نظام تقييم الأداء اليومي وحساب الحسومات"})]}),e.jsxs("div",{className:"bg-white p-3 rounded-xl shadow-sm flex items-center gap-4",children:[e.jsx("span",{className:"text-gray-500 text-sm",children:"إجمالي الحسم المتوقع:"}),e.jsxs("span",{className:"text-2xl font-bold text-red-600 font-mono",children:[E().toFixed(2)," ريال"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-sm",children:[e.jsx("label",{className:"block text-sm font-bold text-gray-700 mb-2",children:"المتعهد"}),e.jsx("select",{className:"w-full p-2 border border-gray-300 rounded-lg",value:v,onChange:s=>o(s.target.value),children:O.map(s=>e.jsx("option",{value:s.id,children:s.name||"Unnamed Supplier"},s.id))})]}),Object.entries(L).map(([s,a])=>e.jsxs("div",{className:"bg-white rounded-xl shadow-sm overflow-hidden",children:[e.jsxs("div",{className:"bg-[#14415A] text-white p-4 flex items-center gap-2",children:[e.jsx(P,{className:"w-5 h-5"}),e.jsx("h3",{className:"font-bold",children:s})]}),e.jsx("div",{className:"p-4 space-y-4",children:a.map(t=>e.jsxs("div",{className:"border-b last:border-0 pb-4 last:pb-0",children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsx("p",{className:"font-medium text-gray-800 w-2/3",children:t.question}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>C(t.id,"compliant"),className:`px-3 py-1 rounded-full text-sm flex items-center gap-1 transition-all ${n[t.id]==="compliant"?"bg-green-100 text-green-700 ring-2 ring-green-500":"bg-gray-100 text-gray-500 hover:bg-gray-200"}`,children:[e.jsx(T,{className:"w-4 h-4"}),"مطابق"]}),e.jsxs("button",{onClick:()=>C(t.id,"non_compliant"),className:`px-3 py-1 rounded-full text-sm flex items-center gap-1 transition-all ${n[t.id]==="non_compliant"?"bg-red-100 text-red-700 ring-2 ring-red-500":"bg-gray-100 text-gray-500 hover:bg-gray-200"}`,children:[e.jsx(F,{className:"w-4 h-4"}),"غير مطابق"]})]})]}),n[t.id]==="non_compliant"&&e.jsx("div",{className:"bg-red-50 p-4 rounded-lg mt-2 animate-in fade-in slide-in-from-top-2",children:e.jsxs("div",{className:"flex gap-4 items-center",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"text-xs font-bold text-red-700 block mb-1",children:"ملاحظة المخالفة"}),e.jsx("input",{type:"text",className:"w-full text-sm border-red-200 rounded-md focus:ring-red-500 focus:border-red-500",placeholder:"وصف المخالفة...",value:h[t.id]||"",onChange:r=>w({...h,[t.id]:r.target.value})})]}),e.jsxs("div",{className:"w-32",children:[e.jsx("label",{className:"text-xs font-bold text-red-700 block mb-1",children:"قيمة الحسم"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",className:"w-full text-sm border-red-200 rounded-md pl-8 focus:ring-red-500 focus:border-red-500",placeholder:"0.00",value:u[t.id]||"",onChange:r=>R(t.id,r.target.value)}),e.jsx(M,{className:"w-4 h-4 text-red-400 absolute left-2 top-2"})]})]})]})})]},t.id))})]},s))]}),e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-sm sticky top-6",children:[e.jsxs("h3",{className:"font-bold text-[#14415A] mb-4 flex items-center gap-2",children:[e.jsx(U,{className:"w-5 h-5"}),"ملخص التقييم"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"عدد البنود المطابقة:"}),e.jsx("span",{className:"font-bold text-green-600",children:Object.values(n).filter(s=>s==="compliant").length})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"عدد المخالفات:"}),e.jsx("span",{className:"font-bold text-red-600",children:Object.values(n).filter(s=>s==="non_compliant").length})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("label",{className:"block text-sm font-bold text-gray-700 mb-2",children:"ملاحظات عامة"}),e.jsx("textarea",{className:"w-full border-gray-300 rounded-lg text-sm",rows:4,placeholder:"أي ملاحظات إضافية...",value:_,onChange:s=>S(s.target.value)})]}),e.jsx("button",{onClick:A,disabled:f,className:"w-full bg-[#14415A] text-white py-3 rounded-lg font-bold hover:bg-[#0e2e40] transition-colors flex justify-center items-center gap-2",children:f?e.jsx(q,{className:"animate-spin w-5 h-5"}):"حفظ التقييم واعتماد الحسومات"})]})]})})]})]})};export{B as QualityControl};
