import{f as T,r as d,j as e,B as c,P as L,C as B,F as G,g as I,h as C,A as k,T as M,i as R,X as V}from"./index-BOMQ6ZnB.js";import{I as o}from"./Input-C08-tSFm.js";const p={1:{infection:!1,unstableVitals:!1,notes:"Stable"},2:{infection:!0,unstableVitals:!0,notes:"Suspected Influenza, High Fever"}},J=()=>{var y,b,v;const{currentUser:s}=T(),[x,g]=d.useState([{id:"LR-001",beneficiaryId:"1",beneficiaryName:"أحمد محمد",requestDate:"2023-11-28",type:"home_visit",startDate:"2023-12-01",endDate:"2023-12-03",durationDays:2,guardianName:"محمد أحمد",guardianPhone:"0500000000",reason:"زيارة عائلية نهاية الأسبوع",status:"PENDING_MEDICAL",history:[{actionBy:"sw-1",actionByName:"سارة الأحمد (أخصائية)",role:"social_worker",actionDate:"2023-11-28T10:00:00Z",action:"request",notes:"تم التواصل مع الولي وتأكيد الموعد"}]}]),[w,m]=d.useState(!1),[t,h]=d.useState(null),[u,j]=d.useState(""),[n,r]=d.useState({type:"home_visit",startDate:"",endDate:"",reason:"",guardianName:"",guardianPhone:""}),[N,f]=d.useState(""),P=()=>{if(!N||!s)return;const a=C.find(l=>l.id===N);if(!a)return;if(a.guardianRelation==="State Ward"||a.socialStatus.includes("يتيم")){alert(`⚠️ تنبيه أمني عالي الخطورة: هذا المستفيد (يتيم/تحت رعاية الدولة). لا يمكن إنشاء طلب خروج أو زيارة إلا بموجب أمر قضائي أو موافقة المدير العام المباشرة.

تم إيقاف العملية لحماية المستفيد.`);return}const i={id:`LR-${Date.now()}`,beneficiaryId:a.id,beneficiaryName:a.fullName,requestDate:new Date().toISOString().split("T")[0],type:n.type,startDate:n.startDate,endDate:n.endDate,durationDays:2,guardianName:n.guardianName,guardianPhone:n.guardianPhone,reason:n.reason,status:"PENDING_MEDICAL",history:[{actionBy:s.id,actionByName:s.name,role:s.role,actionDate:new Date().toISOString(),action:"request",notes:"تم إنشاء الطلب"}]};g([i,...x]),m(!1),r({}),f("")},S=a=>{if(!s)return;let i=a.status,l=a.medicalClearance;s.role==="doctor"&&a.status==="PENDING_MEDICAL"?(i="PENDING_DIRECTOR",l={clearedBy:s.id,clearedAt:new Date().toISOString(),isFit:!0,precautions:u}):s.role==="admin"&&a.status==="PENDING_DIRECTOR"&&(i="APPROVED");const _={...a,status:i,medicalClearance:l,history:[...a.history,{actionBy:s.id,actionByName:s.name,role:s.role,actionDate:new Date().toISOString(),action:"approve",notes:u}]};g(x.map(E=>E.id===a.id?_:E)),h(null),j("")},A=a=>{if(!s)return;const i={...a,status:"REJECTED",history:[...a.history,{actionBy:s.id,actionByName:s.name,role:s.role,actionDate:new Date().toISOString(),action:"reject",notes:u}]};g(x.map(l=>l.id===a.id?i:l)),h(null),j("")},O=a=>{const i={PENDING_SOCIAL:"bg-gray-100 text-gray-800",PENDING_MEDICAL:"bg-blue-100 text-blue-800",PENDING_DIRECTOR:"bg-purple-100 text-purple-800",APPROVED:"bg-green-100 text-green-800",REJECTED:"bg-red-100 text-red-800",ACTIVE:"bg-green-500 text-white",COMPLETED:"bg-gray-500 text-white",OVERDUE:"bg-red-500 text-white"},l={PENDING_SOCIAL:"بانتظار الاجتماعي",PENDING_MEDICAL:"بانتظار الطبي",PENDING_DIRECTOR:"بانتظار المدير",APPROVED:"معتمد",REJECTED:"مرفوض",ACTIVE:"نشط (خارج المركز)",COMPLETED:"مكتمل",OVERDUE:"متأخر"};return e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${i[a]}`,children:l[a]})},D=x.filter(a=>(s==null?void 0:s.role)==="social_worker"?!0:(s==null?void 0:s.role)==="doctor"?a.status==="PENDING_MEDICAL"||a.status==="APPROVED":(s==null?void 0:s.role)==="admin");return e.jsxs("div",{className:"space-y-6 animate-in fade-in",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-xl font-bold",children:"إدارة طلبات الإجازات"}),(s==null?void 0:s.role)==="social_worker"&&e.jsxs(c,{onClick:()=>m(!0),children:[e.jsx(L,{className:"w-4 h-4 ml-2"}),"طلب جديد"]})]}),e.jsxs("div",{className:"grid gap-4",children:[D.map(a=>e.jsxs(B,{className:"p-4 flex justify-between items-center hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"p-3 bg-blue-50 rounded-full",children:e.jsx(G,{className:"w-6 h-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-gray-900",children:a.beneficiaryName}),e.jsxs("div",{className:"text-sm text-gray-500 flex gap-2",children:[e.jsx("span",{children:a.type==="home_visit"?"زيارة منزلية":a.type}),e.jsx("span",{children:"•"}),e.jsxs("span",{children:[a.durationDays," أيام"]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[O(a.status),e.jsx(c,{variant:"outline",size:"sm",onClick:()=>h(a),children:"التفاصيل / إجراء"})]})]},a.id)),D.length===0&&e.jsx("div",{className:"text-center py-10 text-gray-500",children:"لا توجد طلبات حالياً"})]}),e.jsx(I,{isOpen:w,onClose:()=>m(!1),title:"طلب إجازة جديد",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"المستفيد"}),e.jsxs("select",{className:"w-full border rounded-md p-2",value:N,onChange:a=>f(a.target.value),children:[e.jsx("option",{value:"",children:"اختر مستفيد..."}),C.map(a=>e.jsx("option",{value:a.id,children:a.fullName},a.id))]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(o,{type:"date",label:"تاريخ الخروج",value:n.startDate,onChange:a=>r({...n,startDate:a.target.value})}),e.jsx(o,{type:"date",label:"تاريخ العودة",value:n.endDate,onChange:a=>r({...n,endDate:a.target.value})})]}),e.jsx(o,{label:"اسم الولي/المرافق",value:n.guardianName,onChange:a=>r({...n,guardianName:a.target.value})}),e.jsx(o,{label:"رقم التواصل",value:n.guardianPhone,onChange:a=>r({...n,guardianPhone:a.target.value})}),e.jsx(o,{label:"سبب الزيارة",value:n.reason,onChange:a=>r({...n,reason:a.target.value})}),e.jsxs("div",{className:"flex justify-end gap-2 mt-4",children:[e.jsx(c,{variant:"ghost",onClick:()=>m(!1),children:"إلغاء"}),e.jsx(c,{onClick:P,disabled:!N,children:"إنشاء الطلب"})]})]})}),e.jsx(I,{isOpen:!!t,onClose:()=>h(null),title:"تفاصيل الطلب واتخاذ القرار",children:t&&e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"bg-gray-50 p-4 rounded-lg",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"المستفيد:"})," ",e.jsx("span",{className:"font-bold",children:t.beneficiaryName})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"النوع:"})," ",t.type]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"المدة:"})," ",t.startDate," إلى ",t.endDate]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"الولي:"})," ",t.guardianName," (",t.guardianPhone,")"]})]})}),(s==null?void 0:s.role)==="doctor"&&t.status==="PENDING_MEDICAL"&&e.jsxs("div",{className:`p-4 rounded-lg border ${(y=p[t.beneficiaryId])!=null&&y.infection?"bg-red-50 border-red-200":"bg-green-50 border-green-200"}`,children:[e.jsxs("h4",{className:"font-bold flex items-center gap-2 mb-2",children:[e.jsx(k,{className:"w-5 h-5"}),"الحالة الطبية (تحقق تلقائي)"]}),(b=p[t.beneficiaryId])!=null&&b.infection?e.jsxs("div",{className:"text-red-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-4 h-4"})," ",e.jsx("strong",{children:"تحذير:"})," يوجد اشتباه عدوى أو حالة غير مستقرة."]}),e.jsx("p",{className:"mt-1 text-sm",children:(v=p[t.beneficiaryId])==null?void 0:v.notes})]}):e.jsx("div",{className:"text-green-700",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(R,{className:"w-4 h-4"})," الحالة مستقرة. لا توجد موانع طبية ظاهرة."]})})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-sm text-gray-700 mb-2",children:"سجل المتابعة (Audit Trail)"}),e.jsx("div",{className:"border-l-2 border-gray-200 pr-4 space-y-4",children:t.history.map((a,i)=>e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute -right-[21px] top-1 w-3 h-3 bg-gray-400 rounded-full border-2 border-white"}),e.jsxs("p",{className:"text-sm font-semibold",children:[a.actionByName," ",e.jsxs("span",{className:"text-xs font-normal text-gray-500",children:["(",a.role,")"]})]}),e.jsx("p",{className:"text-xs text-gray-400",children:new Date(a.actionDate).toLocaleString("ar-SA")}),e.jsx("p",{className:"text-sm mt-1",children:a.notes})]},i))})]}),((s==null?void 0:s.role)==="doctor"&&t.status==="PENDING_MEDICAL"||(s==null?void 0:s.role)==="admin"&&t.status==="PENDING_DIRECTOR")&&e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"ملاحظات القرار"}),e.jsx("textarea",{className:"w-full border rounded-md p-2 h-24 mb-4",placeholder:"اكتب ملاحظاتك الطبية أو الإدارية هنا...",value:u,onChange:a=>j(a.target.value)}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(c,{className:"flex-1 bg-green-600 hover:bg-green-700",onClick:()=>S(t),children:[e.jsx(R,{className:"w-4 h-4 ml-2"}),"موافقة واعتماد"]}),e.jsxs(c,{className:"flex-1",variant:"danger",onClick:()=>A(t),children:[e.jsx(V,{className:"w-4 h-4 ml-2"}),"رفض الطلب"]})]})]})]})})]})};export{J as LeaveRequestFlow};
